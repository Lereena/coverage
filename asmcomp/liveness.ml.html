<html>
  <head>
    <title>Coverage report</title>
    <link rel="stylesheet" href="../coverage.css" />
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">asmcomp/</span>liveness.ml
        </a>
      </h1>
      <h2>78.76%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:16.77%"></span>
      <span class="unvisited" style="top:24.84%"></span>
      <span class="unvisited" style="top:25.47%"></span>
      <span class="some-visited" style="top:29.81%"></span>
      <span class="unvisited" style="top:40.99%"></span>
      <span class="unvisited" style="top:52.17%"></span>
      <span class="unvisited" style="top:52.80%"></span>
      <span class="unvisited" style="top:53.42%"></span>
      <span class="unvisited" style="top:54.04%"></span>
      <span class="unvisited" style="top:54.66%"></span>
      <span class="unvisited" style="top:55.90%"></span>
      <span class="unvisited" style="top:56.52%"></span>
      <span class="unvisited" style="top:62.11%"></span>
      <span class="unvisited" style="top:62.73%"></span>
      <span class="unvisited" style="top:68.94%"></span>
      <span class="unvisited" style="top:70.19%"></span>
      <span class="unvisited" style="top:70.81%"></span>
      <span class="unvisited" style="top:87.58%"></span>
      <span class="unvisited" style="top:88.82%"></span>
      <span class="unvisited" style="top:91.30%"></span>
      <span class="unvisited" style="top:96.89%"></span>
      <span class="some-visited" style="top:98.14%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span class="visited"> </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span class="unvisited"> </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span class="visited"> </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span class="visited"> </span>
<a id="L39"></a><span class="visited"> </span>
<a id="L40"></a><span class="unvisited"> </span>
<a id="L41"></a><span class="unvisited"> </span>
<a id="L42"></a><span class="visited"> </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span class="visited"> </span>
<a id="L45"></a><span class="visited"> </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span class="visited"> </span>
<a id="L48"></a><span class="some-visited"> </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span class="visited"> </span>
<a id="L51"></a><span class="visited"> </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span class="visited"> </span>
<a id="L54"></a><span class="visited"> </span>
<a id="L55"></a><span class="visited"> </span>
<a id="L56"></a><span class="visited"> </span>
<a id="L57"></a><span class="visited"> </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span class="visited"> </span>
<a id="L61"></a><span class="visited"> </span>
<a id="L62"></a><span class="visited"> </span>
<a id="L63"></a><span class="visited"> </span>
<a id="L64"></a><span class="visited"> </span>
<a id="L65"></a><span class="visited"> </span>
<a id="L66"></a><span class="unvisited"> </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span > </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span > </span>
<a id="L74"></a><span class="visited"> </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span class="visited"> </span>
<a id="L77"></a><span class="visited"> </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span class="visited"> </span>
<a id="L81"></a><span class="visited"> </span>
<a id="L82"></a><span class="visited"> </span>
<a id="L83"></a><span class="visited"> </span>
<a id="L84"></a><span class="unvisited"> </span>
<a id="L85"></a><span class="unvisited"> </span>
<a id="L86"></a><span class="unvisited"> </span>
<a id="L87"></a><span class="unvisited"> </span>
<a id="L88"></a><span class="unvisited"> </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span class="unvisited"> </span>
<a id="L91"></a><span class="unvisited"> </span>
<a id="L92"></a><span class="visited"> </span>
<a id="L93"></a><span class="visited"> </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span class="visited"> </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span class="visited"> </span>
<a id="L100"></a><span class="unvisited"> </span>
<a id="L101"></a><span class="unvisited"> </span>
<a id="L102"></a><span > </span>
<a id="L103"></a><span class="visited"> </span>
<a id="L104"></a><span class="visited"> </span>
<a id="L105"></a><span class="visited"> </span>
<a id="L106"></a><span class="visited"> </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span class="visited"> </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span class="unvisited"> </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="unvisited"> </span>
<a id="L114"></a><span class="unvisited"> </span>
<a id="L115"></a><span > </span>
<a id="L116"></a><span class="visited"> </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span > </span>
<a id="L119"></a><span class="visited"> </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span class="visited"> </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span class="visited"> </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span class="visited"> </span>
<a id="L130"></a><span class="visited"> </span>
<a id="L131"></a><span class="visited"> </span>
<a id="L132"></a><span class="visited"> </span>
<a id="L133"></a><span class="visited"> </span>
<a id="L134"></a><span class="visited"> </span>
<a id="L135"></a><span class="visited"> </span>
<a id="L136"></a><span class="visited"> </span>
<a id="L137"></a><span class="visited"> </span>
<a id="L138"></a><span class="visited"> </span>
<a id="L139"></a><span class="visited"> </span>
<a id="L140"></a><span class="visited"> </span>
<a id="L141"></a><span class="unvisited"> </span>
<a id="L142"></a><span > </span>
<a id="L143"></a><span class="unvisited"> </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span > </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span class="unvisited"> </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span class="visited"> </span>
<a id="L151"></a><span > </span>
<a id="L152"></a><span > </span>
<a id="L153"></a><span class="visited"> </span>
<a id="L154"></a><span class="visited"> </span>
<a id="L155"></a><span class="visited"> </span>
<a id="L156"></a><span class="unvisited"> </span>
<a id="L157"></a><span > </span>
<a id="L158"></a><span class="some-visited"> </span>
<a id="L159"></a><span > </span>
<a id="L160"></a><span > </span>
<a id="L161"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
</pre>
        <pre id="code">
(**************************************************************************)
(*                                                                        *)
(*                                 OCaml                                  *)
(*                                                                        *)
(*             Xavier Leroy, projet Cristal, INRIA Rocquencourt           *)
(*                                                                        *)
(*   Copyright 1996 Institut National de Recherche en Informatique et     *)
(*     en Automatique.                                                    *)
(*                                                                        *)
(*   All rights reserved.  This file is distributed under the terms of    *)
(*   the GNU Lesser General Public License version 2.1, with the          *)
(*   special exception on linking described in the file LICENSE.          *)
(*                                                                        *)
(**************************************************************************)

(* Liveness analysis.
   Annotate mach code with the set of regs live at each point. *)

open Mach

let live_at_exit = <span data-count="2">r</span>ef []

let find_live_at_exit k =
  try
    List.assoc k !live_at_exit
  with
  | <span data-count="0">N</span>ot_found -&gt; Misc.fatal_error "Liveness.find_live_at_exit"

let live_at_raise = <span data-count="2">r</span>ef Reg.Set.empty

let rec live i finally =
  (* finally is the set of registers live after execution of the
     instruction sequence.
     The result of the function is the set of registers live just
     before the instruction sequence.
     The instruction i is annotated by the set of registers live across
     the instruction. *)
  <span data-count="1106">l</span>et arg =
    <span data-count="1106">i</span>f <span data-count="1106">C</span>onfig.spacetime
      &amp;&amp; <span data-count="0">M</span>ach.spacetime_node_hole_pointer_is_live_before i
    then <span data-count="0">A</span>rray.append i.arg [| Proc.loc_spacetime_node_hole |]
    else <span data-count="1106">i</span>.arg
  in
  <span data-count="1106">m</span>atch i.desc with
    <span data-count="21">I</span>end -&gt;
      i.live &lt;- finally;
      <span data-count="21">f</span>inally
  | <span data-count="45">I</span>return | <span data-count="0">I</span>op(Itailcall_ind _) | <span data-count="39">I</span>op(Itailcall_imm _) -&gt;
      i.live &lt;- Reg.Set.empty; (* no regs are live across *)
      <span data-count="84">R</span>eg.set_of_array arg
  | <span data-count="977">I</span>op op -&gt;
      let after = <span data-count="977">l</span>ive i.next finally in
      <span data-count="977">i</span>f <span data-count="977">P</span>roc.op_is_pure op                    (* no side effects *)
      &amp;&amp; <span data-count="1504">R</span>eg.disjoint_set_array after i.res    (* results are not used after *)
      &amp;&amp; <span data-count="14">n</span>ot (Proc.regs_are_volatile arg)      (* no stack-like hard reg *)
      &amp;&amp; <span data-count="7">n</span>ot (Proc.regs_are_volatile i.res)    (*            is involved *)
      then <span data-count="7">b</span>egin
        (* This operation is dead code.  Ignore its arguments. *)
        i.live &lt;- after;
        <span data-count="7">a</span>fter
      end else <span data-count="970">b</span>egin
        let across_after = <span data-count="970">R</span>eg.diff_set_array after i.res in
        <span data-count="970">l</span>et across =
          <span data-count="970">m</span>atch op with
          | <span data-count="15">I</span>call_ind _ | <span data-count="33">I</span>call_imm _ | <span data-count="9">I</span>extcall _ | <span data-count="18">I</span>alloc _
          | <span data-count="0">I</span>intop (Icheckbound _) | <span data-count="0">I</span>intop_imm(Icheckbound _, _) -&gt;
              (* The function call may raise an exception, branching to the
                 nearest enclosing try ... with. Similarly for bounds checks
                 and allocation (for the latter: finalizers may throw
                 exceptions, as may signal handlers).
                 Hence, everything that must be live at the beginning of
                 the exception handler must also be live across this instr. *)
               Reg.Set.union across_after !live_at_raise
           | <span data-count="895">_</span> -&gt;
               across_after in
        <span data-count="970">i</span>.live &lt;- across;
        <span data-count="970">R</span>eg.add_set_array across arg
      end
  | <span data-count="15">I</span>ifthenelse(_test, ifso, ifnot) -&gt;
      let at_join = <span data-count="15">l</span>ive i.next finally in
      <span data-count="15">l</span>et at_fork = <span data-count="15">R</span>eg.Set.union (live ifso at_join) (live ifnot at_join) in
      <span data-count="15">i</span>.live &lt;- at_fork;
      <span data-count="15">R</span>eg.add_set_array at_fork arg
  | <span data-count="0">I</span>switch(_index, cases) -&gt;
      let at_join = <span data-count="0">l</span>ive i.next finally in
      <span data-count="0">l</span>et at_fork = <span data-count="0">r</span>ef Reg.Set.empty in
      <span data-count="0">f</span>or i = 0 to Array.length cases - 1 do
        <span data-count="0">a</span>t_fork := Reg.Set.union !at_fork (live cases.(i) at_join)
      done;
      <span data-count="0">i</span>.live &lt;- !at_fork;
      <span data-count="0">R</span>eg.add_set_array !at_fork arg
  | <span data-count="3">I</span>catch(rec_flag, handlers, body) -&gt;
      let at_join = <span data-count="3">l</span>ive i.next finally in
      <span data-count="3">l</span>et aux (nfail,handler) (nfail', before_handler) =
        <span data-count="3">a</span>ssert(nfail = nfail');
        <span data-count="3">l</span>et before_handler' = <span data-count="3">l</span>ive handler at_join in
        <span data-count="3">n</span>fail, Reg.Set.union before_handler before_handler'
      in
      <span data-count="3">l</span>et aux_equal (nfail, before_handler) (nfail', before_handler') =
        <span data-count="0">a</span>ssert(nfail = nfail');
        <span data-count="0">R</span>eg.Set.equal before_handler before_handler'
      in
      <span data-count="3">l</span>et live_at_exit_before = <span data-count="3">!</span>live_at_exit in
      <span data-count="3">l</span>et rec fixpoint before_handlers =
        <span data-count="3">l</span>ive_at_exit := before_handlers @ !live_at_exit;
        <span data-count="3">l</span>et before_handlers' = <span data-count="3">L</span>ist.map2 aux handlers before_handlers in
        <span data-count="3">l</span>ive_at_exit := live_at_exit_before;
        <span data-count="3">m</span>atch rec_flag with
        | <span data-count="3">C</span>mm.Nonrecursive -&gt;
            before_handlers'
        | <span data-count="0">C</span>mm.Recursive -&gt;
            if List.for_all2 aux_equal before_handlers before_handlers'
            then <span data-count="0">b</span>efore_handlers'
            else <span data-count="0">f</span>ixpoint before_handlers'
      in
      <span data-count="3">l</span>et init_state =
        <span data-count="3">L</span>ist.map (fun (nfail, _handler) -&gt; <span data-count="3">n</span>fail, Reg.Set.empty) handlers
      in
      <span data-count="3">l</span>et before_handler = <span data-count="3">f</span>ixpoint init_state in
      (* We could use handler.live instead of Reg.Set.empty as the initial
         value but we would need to clean the live field before doing the
         analysis (to remove remnants of previous passes). *)
      <span data-count="3">l</span>ive_at_exit := before_handler @ !live_at_exit;
      <span data-count="3">l</span>et before_body = <span data-count="3">l</span>ive body at_join in
      <span data-count="3">l</span>ive_at_exit := live_at_exit_before;
      <span data-count="3">i</span>.live &lt;- before_body;
      <span data-count="3">b</span>efore_body
  | <span data-count="3">I</span>exit nfail -&gt;
      let this_live = <span data-count="3">f</span>ind_live_at_exit nfail in
      <span data-count="3">i</span>.live &lt;- this_live ;
      <span data-count="3">t</span>his_live
  | <span data-count="3">I</span>trywith(body, handler) -&gt;
      let at_join = <span data-count="3">l</span>ive i.next finally in
      <span data-count="3">l</span>et before_handler = <span data-count="3">l</span>ive handler at_join in
      <span data-count="3">l</span>et saved_live_at_raise = <span data-count="3">!</span>live_at_raise in
      <span data-count="3">l</span>ive_at_raise := Reg.Set.remove Proc.loc_exn_bucket before_handler;
      <span data-count="3">l</span>et before_body = <span data-count="3">l</span>ive body at_join in
      <span data-count="3">l</span>ive_at_raise := saved_live_at_raise;
      <span data-count="3">i</span>.live &lt;- before_body;
      <span data-count="3">b</span>efore_body
  | <span data-count="0">I</span>raise _ -&gt;
      i.live &lt;- !live_at_raise;
      <span data-count="0">R</span>eg.add_set_array !live_at_raise arg

let reset () =
  live_at_raise := Reg.Set.empty;
  <span data-count="0">l</span>ive_at_exit := []

let fundecl f =
  let initially_live = <span data-count="66">l</span>ive f.fun_body Reg.Set.empty in
  (* Sanity check: only function parameters (and the Spacetime node hole
     register, if profiling) can be live at entrypoint *)
  <span data-count="66">l</span>et wrong_live = <span data-count="66">R</span>eg.Set.diff initially_live (Reg.set_of_array f.fun_args) in
  <span data-count="66">l</span>et wrong_live =
    <span data-count="66">i</span>f not Config.spacetime then <span data-count="66">w</span>rong_live
    else <span data-count="0">R</span>eg.Set.remove Proc.loc_spacetime_node_hole wrong_live
  in
  <span data-count="66">i</span>f not (Reg.Set.is_empty wrong_live) then <span data-count="0">b</span>egin
    Misc.fatal_errorf "@[Liveness.fundecl:@\n%a@]"
      Printmach.regset wrong_live
  end
</pre>
      </div>
    </div>
    <div id="footer">Generated on 2019-08-19 17:14:36 by <a href="https://github.com/aantron/bisect_ppx">Bisect_ppx</a> 1.4.1</div>
    <script src="../coverage.js"></script>
  </body>
</html>
