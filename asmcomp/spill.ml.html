<html>
  <head>
    <title>Coverage report</title>
    <link rel="stylesheet" href="../coverage.css" />
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">asmcomp/</span>spill.ml
        </a>
      </h1>
      <h2>68.40%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:15.40%"></span>
      <span class="unvisited" style="top:15.63%"></span>
      <span class="unvisited" style="top:16.09%"></span>
      <span class="unvisited" style="top:16.32%"></span>
      <span class="unvisited" style="top:16.78%"></span>
      <span class="unvisited" style="top:17.24%"></span>
      <span class="unvisited" style="top:17.47%"></span>
      <span class="unvisited" style="top:17.70%"></span>
      <span class="unvisited" style="top:18.62%"></span>
      <span class="unvisited" style="top:18.85%"></span>
      <span class="unvisited" style="top:19.08%"></span>
      <span class="unvisited" style="top:19.31%"></span>
      <span class="unvisited" style="top:19.54%"></span>
      <span class="unvisited" style="top:19.77%"></span>
      <span class="unvisited" style="top:20.46%"></span>
      <span class="unvisited" style="top:20.69%"></span>
      <span class="unvisited" style="top:21.15%"></span>
      <span class="unvisited" style="top:21.38%"></span>
      <span class="unvisited" style="top:21.61%"></span>
      <span class="unvisited" style="top:21.84%"></span>
      <span class="unvisited" style="top:22.30%"></span>
      <span class="unvisited" style="top:22.53%"></span>
      <span class="unvisited" style="top:22.99%"></span>
      <span class="unvisited" style="top:23.45%"></span>
      <span class="unvisited" style="top:24.37%"></span>
      <span class="unvisited" style="top:24.83%"></span>
      <span class="unvisited" style="top:25.52%"></span>
      <span class="unvisited" style="top:25.98%"></span>
      <span class="unvisited" style="top:30.57%"></span>
      <span class="some-visited" style="top:32.64%"></span>
      <span class="unvisited" style="top:36.32%"></span>
      <span class="unvisited" style="top:41.61%"></span>
      <span class="unvisited" style="top:41.84%"></span>
      <span class="unvisited" style="top:42.07%"></span>
      <span class="unvisited" style="top:42.30%"></span>
      <span class="unvisited" style="top:42.53%"></span>
      <span class="unvisited" style="top:42.76%"></span>
      <span class="unvisited" style="top:42.99%"></span>
      <span class="unvisited" style="top:43.45%"></span>
      <span class="unvisited" style="top:43.68%"></span>
      <span class="unvisited" style="top:43.91%"></span>
      <span class="unvisited" style="top:44.14%"></span>
      <span class="unvisited" style="top:44.37%"></span>
      <span class="unvisited" style="top:44.83%"></span>
      <span class="unvisited" style="top:45.06%"></span>
      <span class="unvisited" style="top:45.29%"></span>
      <span class="unvisited" style="top:49.66%"></span>
      <span class="unvisited" style="top:49.89%"></span>
      <span class="unvisited" style="top:50.11%"></span>
      <span class="unvisited" style="top:50.34%"></span>
      <span class="unvisited" style="top:50.80%"></span>
      <span class="unvisited" style="top:51.03%"></span>
      <span class="unvisited" style="top:51.26%"></span>
      <span class="unvisited" style="top:58.16%"></span>
      <span class="unvisited" style="top:64.60%"></span>
      <span class="some-visited" style="top:68.28%"></span>
      <span class="unvisited" style="top:71.26%"></span>
      <span class="unvisited" style="top:74.48%"></span>
      <span class="unvisited" style="top:78.39%"></span>
      <span class="unvisited" style="top:78.62%"></span>
      <span class="unvisited" style="top:78.85%"></span>
      <span class="unvisited" style="top:79.08%"></span>
      <span class="unvisited" style="top:79.31%"></span>
      <span class="unvisited" style="top:79.54%"></span>
      <span class="unvisited" style="top:79.77%"></span>
      <span class="unvisited" style="top:80.23%"></span>
      <span class="unvisited" style="top:80.46%"></span>
      <span class="unvisited" style="top:80.69%"></span>
      <span class="unvisited" style="top:81.15%"></span>
      <span class="unvisited" style="top:81.38%"></span>
      <span class="unvisited" style="top:86.21%"></span>
      <span class="unvisited" style="top:86.67%"></span>
      <span class="unvisited" style="top:87.13%"></span>
      <span class="unvisited" style="top:87.59%"></span>
      <span class="unvisited" style="top:87.82%"></span>
      <span class="unvisited" style="top:88.05%"></span>
      <span class="unvisited" style="top:93.79%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span class="visited"> </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span > </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span class="visited"> </span>
<a id="L44"></a><span class="visited"> </span>
<a id="L45"></a><span class="visited"> </span>
<a id="L46"></a><span class="visited"> </span>
<a id="L47"></a><span class="visited"> </span>
<a id="L48"></a><span class="visited"> </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span class="visited"> </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span > </span>
<a id="L57"></a><span class="visited"> </span>
<a id="L58"></a><span class="visited"> </span>
<a id="L59"></a><span class="visited"> </span>
<a id="L60"></a><span class="visited"> </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span > </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span > </span>
<a id="L67"></a><span class="unvisited"> </span>
<a id="L68"></a><span class="unvisited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span class="unvisited"> </span>
<a id="L71"></a><span class="unvisited"> </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span class="unvisited"> </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span class="unvisited"> </span>
<a id="L76"></a><span class="unvisited"> </span>
<a id="L77"></a><span class="unvisited"> </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span > </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span class="unvisited"> </span>
<a id="L82"></a><span class="unvisited"> </span>
<a id="L83"></a><span class="unvisited"> </span>
<a id="L84"></a><span class="unvisited"> </span>
<a id="L85"></a><span class="unvisited"> </span>
<a id="L86"></a><span class="unvisited"> </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span class="unvisited"> </span>
<a id="L90"></a><span class="unvisited"> </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span class="unvisited"> </span>
<a id="L93"></a><span class="unvisited"> </span>
<a id="L94"></a><span class="unvisited"> </span>
<a id="L95"></a><span class="unvisited"> </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span class="unvisited"> </span>
<a id="L98"></a><span class="unvisited"> </span>
<a id="L99"></a><span > </span>
<a id="L100"></a><span class="unvisited"> </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span class="unvisited"> </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span class="unvisited"> </span>
<a id="L107"></a><span > </span>
<a id="L108"></a><span class="unvisited"> </span>
<a id="L109"></a><span > </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span class="unvisited"> </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="unvisited"> </span>
<a id="L114"></a><span > </span>
<a id="L115"></a><span > </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span > </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span class="visited"> </span>
<a id="L125"></a><span > </span>
<a id="L126"></a><span > </span>
<a id="L127"></a><span class="visited"> </span>
<a id="L128"></a><span > </span>
<a id="L129"></a><span > </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span > </span>
<a id="L132"></a><span > </span>
<a id="L133"></a><span class="unvisited"> </span>
<a id="L134"></a><span > </span>
<a id="L135"></a><span > </span>
<a id="L136"></a><span class="visited"> </span>
<a id="L137"></a><span class="visited"> </span>
<a id="L138"></a><span class="visited"> </span>
<a id="L139"></a><span class="visited"> </span>
<a id="L140"></a><span class="visited"> </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span class="some-visited"> </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span class="visited"> </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span class="visited"> </span>
<a id="L148"></a><span class="visited"> </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span > </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span > </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span class="visited"> </span>
<a id="L155"></a><span class="visited"> </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span class="visited"> </span>
<a id="L158"></a><span class="unvisited"> </span>
<a id="L159"></a><span class="visited"> </span>
<a id="L160"></a><span class="visited"> </span>
<a id="L161"></a><span class="visited"> </span>
<a id="L162"></a><span class="visited"> </span>
<a id="L163"></a><span > </span>
<a id="L164"></a><span > </span>
<a id="L165"></a><span class="visited"> </span>
<a id="L166"></a><span class="visited"> </span>
<a id="L167"></a><span class="visited"> </span>
<a id="L168"></a><span class="visited"> </span>
<a id="L169"></a><span class="visited"> </span>
<a id="L170"></a><span class="visited"> </span>
<a id="L171"></a><span class="visited"> </span>
<a id="L172"></a><span class="visited"> </span>
<a id="L173"></a><span class="visited"> </span>
<a id="L174"></a><span class="visited"> </span>
<a id="L175"></a><span class="visited"> </span>
<a id="L176"></a><span class="visited"> </span>
<a id="L177"></a><span > </span>
<a id="L178"></a><span class="visited"> </span>
<a id="L179"></a><span class="visited"> </span>
<a id="L180"></a><span > </span>
<a id="L181"></a><span class="unvisited"> </span>
<a id="L182"></a><span class="unvisited"> </span>
<a id="L183"></a><span class="unvisited"> </span>
<a id="L184"></a><span class="unvisited"> </span>
<a id="L185"></a><span class="unvisited"> </span>
<a id="L186"></a><span class="unvisited"> </span>
<a id="L187"></a><span class="unvisited"> </span>
<a id="L188"></a><span > </span>
<a id="L189"></a><span class="unvisited"> </span>
<a id="L190"></a><span class="unvisited"> </span>
<a id="L191"></a><span class="unvisited"> </span>
<a id="L192"></a><span class="unvisited"> </span>
<a id="L193"></a><span class="unvisited"> </span>
<a id="L194"></a><span > </span>
<a id="L195"></a><span class="unvisited"> </span>
<a id="L196"></a><span class="unvisited"> </span>
<a id="L197"></a><span class="unvisited"> </span>
<a id="L198"></a><span > </span>
<a id="L199"></a><span > </span>
<a id="L200"></a><span > </span>
<a id="L201"></a><span class="visited"> </span>
<a id="L202"></a><span class="visited"> </span>
<a id="L203"></a><span class="visited"> </span>
<a id="L204"></a><span class="visited"> </span>
<a id="L205"></a><span class="visited"> </span>
<a id="L206"></a><span class="visited"> </span>
<a id="L207"></a><span class="visited"> </span>
<a id="L208"></a><span class="visited"> </span>
<a id="L209"></a><span class="visited"> </span>
<a id="L210"></a><span class="visited"> </span>
<a id="L211"></a><span class="visited"> </span>
<a id="L212"></a><span class="visited"> </span>
<a id="L213"></a><span class="visited"> </span>
<a id="L214"></a><span class="visited"> </span>
<a id="L215"></a><span > </span>
<a id="L216"></a><span class="unvisited"> </span>
<a id="L217"></a><span class="unvisited"> </span>
<a id="L218"></a><span class="unvisited"> </span>
<a id="L219"></a><span class="unvisited"> </span>
<a id="L220"></a><span > </span>
<a id="L221"></a><span class="unvisited"> </span>
<a id="L222"></a><span class="unvisited"> </span>
<a id="L223"></a><span class="unvisited"> </span>
<a id="L224"></a><span > </span>
<a id="L225"></a><span class="visited"> </span>
<a id="L226"></a><span class="visited"> </span>
<a id="L227"></a><span class="visited"> </span>
<a id="L228"></a><span class="visited"> </span>
<a id="L229"></a><span > </span>
<a id="L230"></a><span class="visited"> </span>
<a id="L231"></a><span class="visited"> </span>
<a id="L232"></a><span class="visited"> </span>
<a id="L233"></a><span > </span>
<a id="L234"></a><span class="visited"> </span>
<a id="L235"></a><span > </span>
<a id="L236"></a><span > </span>
<a id="L237"></a><span class="visited"> </span>
<a id="L238"></a><span class="visited"> </span>
<a id="L239"></a><span class="visited"> </span>
<a id="L240"></a><span class="visited"> </span>
<a id="L241"></a><span class="visited"> </span>
<a id="L242"></a><span class="visited"> </span>
<a id="L243"></a><span > </span>
<a id="L244"></a><span > </span>
<a id="L245"></a><span class="visited"> </span>
<a id="L246"></a><span class="visited"> </span>
<a id="L247"></a><span > </span>
<a id="L248"></a><span class="visited"> </span>
<a id="L249"></a><span class="visited"> </span>
<a id="L250"></a><span class="visited"> </span>
<a id="L251"></a><span class="visited"> </span>
<a id="L252"></a><span > </span>
<a id="L253"></a><span class="unvisited"> </span>
<a id="L254"></a><span > </span>
<a id="L255"></a><span > </span>
<a id="L256"></a><span > </span>
<a id="L257"></a><span > </span>
<a id="L258"></a><span > </span>
<a id="L259"></a><span > </span>
<a id="L260"></a><span > </span>
<a id="L261"></a><span > </span>
<a id="L262"></a><span > </span>
<a id="L263"></a><span > </span>
<a id="L264"></a><span > </span>
<a id="L265"></a><span > </span>
<a id="L266"></a><span > </span>
<a id="L267"></a><span > </span>
<a id="L268"></a><span > </span>
<a id="L269"></a><span > </span>
<a id="L270"></a><span > </span>
<a id="L271"></a><span > </span>
<a id="L272"></a><span > </span>
<a id="L273"></a><span > </span>
<a id="L274"></a><span class="visited"> </span>
<a id="L275"></a><span > </span>
<a id="L276"></a><span > </span>
<a id="L277"></a><span class="visited"> </span>
<a id="L278"></a><span class="visited"> </span>
<a id="L279"></a><span class="visited"> </span>
<a id="L280"></a><span > </span>
<a id="L281"></a><span class="unvisited"> </span>
<a id="L282"></a><span > </span>
<a id="L283"></a><span class="visited"> </span>
<a id="L284"></a><span class="visited"> </span>
<a id="L285"></a><span class="visited"> </span>
<a id="L286"></a><span class="visited"> </span>
<a id="L287"></a><span > </span>
<a id="L288"></a><span > </span>
<a id="L289"></a><span class="visited"> </span>
<a id="L290"></a><span class="visited"> </span>
<a id="L291"></a><span > </span>
<a id="L292"></a><span > </span>
<a id="L293"></a><span > </span>
<a id="L294"></a><span class="visited"> </span>
<a id="L295"></a><span class="visited"> </span>
<a id="L296"></a><span > </span>
<a id="L297"></a><span class="some-visited"> </span>
<a id="L298"></a><span > </span>
<a id="L299"></a><span class="visited"> </span>
<a id="L300"></a><span class="visited"> </span>
<a id="L301"></a><span class="visited"> </span>
<a id="L302"></a><span class="visited"> </span>
<a id="L303"></a><span > </span>
<a id="L304"></a><span class="visited"> </span>
<a id="L305"></a><span class="visited"> </span>
<a id="L306"></a><span class="visited"> </span>
<a id="L307"></a><span class="visited"> </span>
<a id="L308"></a><span class="visited"> </span>
<a id="L309"></a><span class="visited"> </span>
<a id="L310"></a><span class="unvisited"> </span>
<a id="L311"></a><span > </span>
<a id="L312"></a><span class="visited"> </span>
<a id="L313"></a><span > </span>
<a id="L314"></a><span class="visited"> </span>
<a id="L315"></a><span > </span>
<a id="L316"></a><span > </span>
<a id="L317"></a><span class="visited"> </span>
<a id="L318"></a><span class="visited"> </span>
<a id="L319"></a><span class="visited"> </span>
<a id="L320"></a><span class="visited"> </span>
<a id="L321"></a><span class="visited"> </span>
<a id="L322"></a><span class="visited"> </span>
<a id="L323"></a><span > </span>
<a id="L324"></a><span class="unvisited"> </span>
<a id="L325"></a><span > </span>
<a id="L326"></a><span > </span>
<a id="L327"></a><span class="visited"> </span>
<a id="L328"></a><span class="visited"> </span>
<a id="L329"></a><span class="visited"> </span>
<a id="L330"></a><span class="visited"> </span>
<a id="L331"></a><span > </span>
<a id="L332"></a><span class="visited"> </span>
<a id="L333"></a><span class="visited"> </span>
<a id="L334"></a><span > </span>
<a id="L335"></a><span > </span>
<a id="L336"></a><span > </span>
<a id="L337"></a><span > </span>
<a id="L338"></a><span > </span>
<a id="L339"></a><span > </span>
<a id="L340"></a><span > </span>
<a id="L341"></a><span class="unvisited"> </span>
<a id="L342"></a><span class="unvisited"> </span>
<a id="L343"></a><span class="unvisited"> </span>
<a id="L344"></a><span class="unvisited"> </span>
<a id="L345"></a><span class="unvisited"> </span>
<a id="L346"></a><span class="unvisited"> </span>
<a id="L347"></a><span class="unvisited"> </span>
<a id="L348"></a><span > </span>
<a id="L349"></a><span class="unvisited"> </span>
<a id="L350"></a><span class="unvisited"> </span>
<a id="L351"></a><span class="unvisited"> </span>
<a id="L352"></a><span > </span>
<a id="L353"></a><span class="unvisited"> </span>
<a id="L354"></a><span class="unvisited"> </span>
<a id="L355"></a><span > </span>
<a id="L356"></a><span class="visited"> </span>
<a id="L357"></a><span class="visited"> </span>
<a id="L358"></a><span class="visited"> </span>
<a id="L359"></a><span class="visited"> </span>
<a id="L360"></a><span class="visited"> </span>
<a id="L361"></a><span class="visited"> </span>
<a id="L362"></a><span class="visited"> </span>
<a id="L363"></a><span > </span>
<a id="L364"></a><span > </span>
<a id="L365"></a><span class="visited"> </span>
<a id="L366"></a><span class="visited"> </span>
<a id="L367"></a><span class="visited"> </span>
<a id="L368"></a><span class="visited"> </span>
<a id="L369"></a><span class="visited"> </span>
<a id="L370"></a><span > </span>
<a id="L371"></a><span class="visited"> </span>
<a id="L372"></a><span class="visited"> </span>
<a id="L373"></a><span class="visited"> </span>
<a id="L374"></a><span > </span>
<a id="L375"></a><span class="unvisited"> </span>
<a id="L376"></a><span > </span>
<a id="L377"></a><span class="unvisited"> </span>
<a id="L378"></a><span > </span>
<a id="L379"></a><span class="unvisited"> </span>
<a id="L380"></a><span > </span>
<a id="L381"></a><span class="unvisited"> </span>
<a id="L382"></a><span class="unvisited"> </span>
<a id="L383"></a><span class="unvisited"> </span>
<a id="L384"></a><span > </span>
<a id="L385"></a><span class="visited"> </span>
<a id="L386"></a><span class="visited"> </span>
<a id="L387"></a><span class="visited"> </span>
<a id="L388"></a><span class="visited"> </span>
<a id="L389"></a><span class="visited"> </span>
<a id="L390"></a><span class="visited"> </span>
<a id="L391"></a><span class="visited"> </span>
<a id="L392"></a><span class="visited"> </span>
<a id="L393"></a><span > </span>
<a id="L394"></a><span class="visited"> </span>
<a id="L395"></a><span > </span>
<a id="L396"></a><span > </span>
<a id="L397"></a><span class="visited"> </span>
<a id="L398"></a><span > </span>
<a id="L399"></a><span class="visited"> </span>
<a id="L400"></a><span class="visited"> </span>
<a id="L401"></a><span class="visited"> </span>
<a id="L402"></a><span class="visited"> </span>
<a id="L403"></a><span class="visited"> </span>
<a id="L404"></a><span class="visited"> </span>
<a id="L405"></a><span class="visited"> </span>
<a id="L406"></a><span class="visited"> </span>
<a id="L407"></a><span > </span>
<a id="L408"></a><span class="unvisited"> </span>
<a id="L409"></a><span > </span>
<a id="L410"></a><span > </span>
<a id="L411"></a><span > </span>
<a id="L412"></a><span > </span>
<a id="L413"></a><span > </span>
<a id="L414"></a><span > </span>
<a id="L415"></a><span class="visited"> </span>
<a id="L416"></a><span class="visited"> </span>
<a id="L417"></a><span class="visited"> </span>
<a id="L418"></a><span > </span>
<a id="L419"></a><span > </span>
<a id="L420"></a><span > </span>
<a id="L421"></a><span > </span>
<a id="L422"></a><span class="visited"> </span>
<a id="L423"></a><span class="visited"> </span>
<a id="L424"></a><span class="visited"> </span>
<a id="L425"></a><span class="visited"> </span>
<a id="L426"></a><span class="visited"> </span>
<a id="L427"></a><span class="visited"> </span>
<a id="L428"></a><span class="visited"> </span>
<a id="L429"></a><span class="visited"> </span>
<a id="L430"></a><span > </span>
<a id="L431"></a><span > </span>
<a id="L432"></a><span > </span>
<a id="L433"></a><span > </span>
<a id="L434"></a><span > </span>
<a id="L435"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
<a href="#L235">235</a>
<a href="#L236">236</a>
<a href="#L237">237</a>
<a href="#L238">238</a>
<a href="#L239">239</a>
<a href="#L240">240</a>
<a href="#L241">241</a>
<a href="#L242">242</a>
<a href="#L243">243</a>
<a href="#L244">244</a>
<a href="#L245">245</a>
<a href="#L246">246</a>
<a href="#L247">247</a>
<a href="#L248">248</a>
<a href="#L249">249</a>
<a href="#L250">250</a>
<a href="#L251">251</a>
<a href="#L252">252</a>
<a href="#L253">253</a>
<a href="#L254">254</a>
<a href="#L255">255</a>
<a href="#L256">256</a>
<a href="#L257">257</a>
<a href="#L258">258</a>
<a href="#L259">259</a>
<a href="#L260">260</a>
<a href="#L261">261</a>
<a href="#L262">262</a>
<a href="#L263">263</a>
<a href="#L264">264</a>
<a href="#L265">265</a>
<a href="#L266">266</a>
<a href="#L267">267</a>
<a href="#L268">268</a>
<a href="#L269">269</a>
<a href="#L270">270</a>
<a href="#L271">271</a>
<a href="#L272">272</a>
<a href="#L273">273</a>
<a href="#L274">274</a>
<a href="#L275">275</a>
<a href="#L276">276</a>
<a href="#L277">277</a>
<a href="#L278">278</a>
<a href="#L279">279</a>
<a href="#L280">280</a>
<a href="#L281">281</a>
<a href="#L282">282</a>
<a href="#L283">283</a>
<a href="#L284">284</a>
<a href="#L285">285</a>
<a href="#L286">286</a>
<a href="#L287">287</a>
<a href="#L288">288</a>
<a href="#L289">289</a>
<a href="#L290">290</a>
<a href="#L291">291</a>
<a href="#L292">292</a>
<a href="#L293">293</a>
<a href="#L294">294</a>
<a href="#L295">295</a>
<a href="#L296">296</a>
<a href="#L297">297</a>
<a href="#L298">298</a>
<a href="#L299">299</a>
<a href="#L300">300</a>
<a href="#L301">301</a>
<a href="#L302">302</a>
<a href="#L303">303</a>
<a href="#L304">304</a>
<a href="#L305">305</a>
<a href="#L306">306</a>
<a href="#L307">307</a>
<a href="#L308">308</a>
<a href="#L309">309</a>
<a href="#L310">310</a>
<a href="#L311">311</a>
<a href="#L312">312</a>
<a href="#L313">313</a>
<a href="#L314">314</a>
<a href="#L315">315</a>
<a href="#L316">316</a>
<a href="#L317">317</a>
<a href="#L318">318</a>
<a href="#L319">319</a>
<a href="#L320">320</a>
<a href="#L321">321</a>
<a href="#L322">322</a>
<a href="#L323">323</a>
<a href="#L324">324</a>
<a href="#L325">325</a>
<a href="#L326">326</a>
<a href="#L327">327</a>
<a href="#L328">328</a>
<a href="#L329">329</a>
<a href="#L330">330</a>
<a href="#L331">331</a>
<a href="#L332">332</a>
<a href="#L333">333</a>
<a href="#L334">334</a>
<a href="#L335">335</a>
<a href="#L336">336</a>
<a href="#L337">337</a>
<a href="#L338">338</a>
<a href="#L339">339</a>
<a href="#L340">340</a>
<a href="#L341">341</a>
<a href="#L342">342</a>
<a href="#L343">343</a>
<a href="#L344">344</a>
<a href="#L345">345</a>
<a href="#L346">346</a>
<a href="#L347">347</a>
<a href="#L348">348</a>
<a href="#L349">349</a>
<a href="#L350">350</a>
<a href="#L351">351</a>
<a href="#L352">352</a>
<a href="#L353">353</a>
<a href="#L354">354</a>
<a href="#L355">355</a>
<a href="#L356">356</a>
<a href="#L357">357</a>
<a href="#L358">358</a>
<a href="#L359">359</a>
<a href="#L360">360</a>
<a href="#L361">361</a>
<a href="#L362">362</a>
<a href="#L363">363</a>
<a href="#L364">364</a>
<a href="#L365">365</a>
<a href="#L366">366</a>
<a href="#L367">367</a>
<a href="#L368">368</a>
<a href="#L369">369</a>
<a href="#L370">370</a>
<a href="#L371">371</a>
<a href="#L372">372</a>
<a href="#L373">373</a>
<a href="#L374">374</a>
<a href="#L375">375</a>
<a href="#L376">376</a>
<a href="#L377">377</a>
<a href="#L378">378</a>
<a href="#L379">379</a>
<a href="#L380">380</a>
<a href="#L381">381</a>
<a href="#L382">382</a>
<a href="#L383">383</a>
<a href="#L384">384</a>
<a href="#L385">385</a>
<a href="#L386">386</a>
<a href="#L387">387</a>
<a href="#L388">388</a>
<a href="#L389">389</a>
<a href="#L390">390</a>
<a href="#L391">391</a>
<a href="#L392">392</a>
<a href="#L393">393</a>
<a href="#L394">394</a>
<a href="#L395">395</a>
<a href="#L396">396</a>
<a href="#L397">397</a>
<a href="#L398">398</a>
<a href="#L399">399</a>
<a href="#L400">400</a>
<a href="#L401">401</a>
<a href="#L402">402</a>
<a href="#L403">403</a>
<a href="#L404">404</a>
<a href="#L405">405</a>
<a href="#L406">406</a>
<a href="#L407">407</a>
<a href="#L408">408</a>
<a href="#L409">409</a>
<a href="#L410">410</a>
<a href="#L411">411</a>
<a href="#L412">412</a>
<a href="#L413">413</a>
<a href="#L414">414</a>
<a href="#L415">415</a>
<a href="#L416">416</a>
<a href="#L417">417</a>
<a href="#L418">418</a>
<a href="#L419">419</a>
<a href="#L420">420</a>
<a href="#L421">421</a>
<a href="#L422">422</a>
<a href="#L423">423</a>
<a href="#L424">424</a>
<a href="#L425">425</a>
<a href="#L426">426</a>
<a href="#L427">427</a>
<a href="#L428">428</a>
<a href="#L429">429</a>
<a href="#L430">430</a>
<a href="#L431">431</a>
<a href="#L432">432</a>
<a href="#L433">433</a>
<a href="#L434">434</a>
<a href="#L435">435</a>
</pre>
        <pre id="code">
(**************************************************************************)
(*                                                                        *)
(*                                 OCaml                                  *)
(*                                                                        *)
(*             Xavier Leroy, projet Cristal, INRIA Rocquencourt           *)
(*                                                                        *)
(*   Copyright 1996 Institut National de Recherche en Informatique et     *)
(*     en Automatique.                                                    *)
(*                                                                        *)
(*   All rights reserved.  This file is distributed under the terms of    *)
(*   the GNU Lesser General Public License version 2.1, with the          *)
(*   special exception on linking described in the file LICENSE.          *)
(*                                                                        *)
(**************************************************************************)

(* Insertion of moves to suggest possible spilling / reloading points
   before register allocation. *)

open Reg
open Mach

(* We say that a register is "destroyed" if it is live across a construct
   that potentially destroys all physical registers: function calls or
   try...with constructs.

   The "destroyed" registers must therefore reside in the stack during
   these instructions.. We will insert spills (stores) just after they
   are defined, and reloads just before their first use following a
   "destroying" construct.

   Instructions with more live registers than actual registers also
   "destroy" registers: we mark as "destroyed" the registers live
   across the instruction that haven't been used for the longest time.
   These registers will be spilled and reloaded as described above. *)

(* Association of spill registers to registers *)

let spill_env = <span data-count="2">r</span>ef (Reg.Map.empty : Reg.t Reg.Map.t)

let spill_reg r =
  try
    Reg.Map.find r !spill_env
  with <span data-count="7">N</span>ot_found -&gt;
    let spill_r = <span data-count="7">R</span>eg.create r.typ in
    <span data-count="7">s</span>pill_r.spill &lt;- true;
    <span data-count="7">i</span>f not (Reg.anonymous r) then <span data-count="7">s</span>pill_r.raw_name &lt;- r.raw_name;
    <span data-count="7">s</span>pill_env := Reg.Map.add r spill_r !spill_env;
    <span data-count="7">s</span>pill_r

(* Record the position of last use of registers *)

let use_date = <span data-count="2">r</span>ef (Reg.Map.empty : int Reg.Map.t)
let current_date = <span data-count="2">r</span>ef 0

let record_use regv =
  for i = 0 to Array.length regv - 1 do
    <span data-count="594">l</span>et r = <span data-count="594">r</span>egv.(i) in
    <span data-count="594">l</span>et prev_date = <span data-count="594">t</span>ry Reg.Map.find r !use_date with <span data-count="220">N</span>ot_found -&gt; 0 in
    <span data-count="594">i</span>f !current_date &gt; prev_date then
      <span data-count="577">u</span>se_date := Reg.Map.add r !current_date !use_date
  done

(* Check if the register pressure overflows the maximum pressure allowed
   at that point. If so, spill enough registers to lower the pressure. *)

let add_superpressure_regs op live_regs res_regs spilled =
  <span data-count="0">l</span>et max_pressure = <span data-count="0">P</span>roc.max_register_pressure op in
  <span data-count="0">l</span>et regs = <span data-count="0">R</span>eg.add_set_array live_regs res_regs in
  (* Compute the pressure in each register class *)
  <span data-count="0">l</span>et pressure = <span data-count="0">A</span>rray.make Proc.num_register_classes 0 in
  <span data-count="0">R</span>eg.Set.iter
    (fun r -&gt;
      <span data-count="0">i</span>f Reg.Set.mem r spilled then <span data-count="0">(</span>) else <span data-count="0">b</span>egin
        match r.loc with
          <span data-count="0">S</span>tack _ -&gt; ()
        | <span data-count="0">_</span> -&gt; let c = <span data-count="0">P</span>roc.register_class r in
               <span data-count="0">p</span>ressure.(c) &lt;- pressure.(c) + 1
      end)
    regs;
  (* Check if pressure is exceeded for each class. *)
  <span data-count="0">l</span>et rec check_pressure cl spilled =
    <span data-count="0">i</span>f cl &gt;= Proc.num_register_classes then
      <span data-count="0">s</span>pilled
    else <span data-count="0">i</span>f pressure.(cl) &lt;= max_pressure.(cl) then
      <span data-count="0">c</span>heck_pressure (cl+1) spilled
    else <span data-count="0">b</span>egin
      (* Find the least recently used, unspilled, unallocated, live register
         in the class *)
      let lru_date = <span data-count="0">r</span>ef 1000000 and lru_reg = <span data-count="0">r</span>ef Reg.dummy in
      <span data-count="0">R</span>eg.Set.iter
        (fun r -&gt;
          <span data-count="0">i</span>f <span data-count="0">P</span>roc.register_class r = cl &amp;&amp;
             <span data-count="0">n</span>ot (Reg.Set.mem r spilled) &amp;&amp;
             <span data-count="0">r</span>.loc = Unknown
          then <span data-count="0">b</span>egin
            try
              let d = <span data-count="0">R</span>eg.Map.find r !use_date in
              <span data-count="0">i</span>f d &lt; !lru_date then <span data-count="0">b</span>egin
                lru_date := d;
                <span data-count="0">l</span>ru_reg := r
              end
            with <span data-count="0">N</span>ot_found -&gt;                 (* Should not happen *)
              ()
          end)
        live_regs;
      <span data-count="0">i</span>f !lru_reg != Reg.dummy then <span data-count="0">b</span>egin
        pressure.(cl) &lt;- pressure.(cl) - 1;
        <span data-count="0">c</span>heck_pressure cl (Reg.Set.add !lru_reg spilled)
      end else
        (* Couldn't find any spillable register, give up for this class *)
        <span data-count="0">c</span>heck_pressure (cl+1) spilled
    end in
  <span data-count="0">c</span>heck_pressure 0 spilled

(* A-list recording what is destroyed at if-then-else points. *)

let destroyed_at_fork = <span data-count="2">r</span>ef ([] : (instruction * Reg.Set.t) list)

(* First pass: insert reload instructions based on an approximation of
   what is destroyed at pressure points. *)

let add_reloads regset i =
  <span data-count="347">R</span>eg.Set.fold
    (fun r i -&gt; <span data-count="7">i</span>nstr_cons (Iop Ireload) [|spill_reg r|] [|r|] i)
    regset i

let reload_at_exit = <span data-count="2">r</span>ef []

let find_reload_at_exit k =
  try
    List.assoc k !reload_at_exit
  with
  | <span data-count="0">N</span>ot_found -&gt; Misc.fatal_error "Spill.find_reload_at_exit"

let rec reload i before =
  <span data-count="357">i</span>ncr current_date;
  <span data-count="357">r</span>ecord_use i.arg;
  <span data-count="357">r</span>ecord_use i.res;
  <span data-count="357">m</span>atch i.desc with
    <span data-count="7">I</span>end -&gt;
      (i, before)
  | <span data-count="15">I</span>return | <span data-count="0">I</span>op(Itailcall_ind _) | <span data-count="13">I</span>op(Itailcall_imm _) -&gt;
      (add_reloads (Reg.inter_set_array before i.arg) i,
       Reg.Set.empty)
  | Iop(<span data-count="5">I</span>call_ind _ | <span data-count="11">I</span>call_imm _ | <span data-count="3">I</span>extcall { alloc = true; }) -&gt;
      (* All regs live across must be spilled *)
      let (new_next, finally) = <span data-count="19">r</span>eload i.next i.live in
      <span data-count="19">(</span>add_reloads (Reg.inter_set_array before i.arg)
                   (instr_cons_debug i.desc i.arg i.res i.dbg new_next),
       finally)
  | <span data-count="295">I</span>op op -&gt;
      let new_before =
        (* Quick check to see if the register pressure is below the maximum *)
        <span data-count="295">i</span>f <span data-count="295">!</span>Clflags.use_linscan ||
           <span data-count="295">(</span>Reg.Set.cardinal i.live + Array.length i.res &lt;=
            Proc.safe_register_pressure op)
        then <span data-count="295">b</span>efore
        else <span data-count="0">a</span>dd_superpressure_regs op i.live i.res before in
      <span data-count="295">l</span>et after =
        <span data-count="295">R</span>eg.diff_set_array (Reg.diff_set_array new_before i.arg) i.res in
      <span data-count="295">l</span>et (new_next, finally) = <span data-count="295">r</span>eload i.next after in
      <span data-count="295">(</span>add_reloads (Reg.inter_set_array new_before i.arg)
                   (instr_cons_debug i.desc i.arg i.res i.dbg new_next),
       finally)
  | <span data-count="5">I</span>ifthenelse(test, ifso, ifnot) -&gt;
      let at_fork = <span data-count="5">R</span>eg.diff_set_array before i.arg in
      <span data-count="5">l</span>et date_fork = <span data-count="5">!</span>current_date in
      <span data-count="5">l</span>et (new_ifso, after_ifso) = <span data-count="5">r</span>eload ifso at_fork in
      <span data-count="5">l</span>et date_ifso = <span data-count="5">!</span>current_date in
      <span data-count="5">c</span>urrent_date := date_fork;
      <span data-count="5">l</span>et (new_ifnot, after_ifnot) = <span data-count="5">r</span>eload ifnot at_fork in
      <span data-count="5">c</span>urrent_date := max date_ifso !current_date;
      <span data-count="5">l</span>et (new_next, finally) =
        <span data-count="5">r</span>eload i.next (Reg.Set.union after_ifso after_ifnot) in
      <span data-count="5">l</span>et new_i =
        <span data-count="5">i</span>nstr_cons (Iifthenelse(test, new_ifso, new_ifnot))
        i.arg i.res new_next in
      <span data-count="5">d</span>estroyed_at_fork := (new_i, at_fork) :: !destroyed_at_fork;
      <span data-count="5">(</span>add_reloads (Reg.inter_set_array before i.arg) new_i,
       finally)
  | <span data-count="0">I</span>switch(index, cases) -&gt;
      let at_fork = <span data-count="0">R</span>eg.diff_set_array before i.arg in
      <span data-count="0">l</span>et date_fork = <span data-count="0">!</span>current_date in
      <span data-count="0">l</span>et date_join = <span data-count="0">r</span>ef 0 in
      <span data-count="0">l</span>et after_cases = <span data-count="0">r</span>ef Reg.Set.empty in
      <span data-count="0">l</span>et new_cases =
        <span data-count="0">A</span>rray.map
          (fun c -&gt;
            <span data-count="0">c</span>urrent_date := date_fork;
            <span data-count="0">l</span>et (new_c, after_c) = <span data-count="0">r</span>eload c at_fork in
            <span data-count="0">a</span>fter_cases := Reg.Set.union !after_cases after_c;
            <span data-count="0">d</span>ate_join := max !date_join !current_date;
            <span data-count="0">n</span>ew_c)
          cases in
      <span data-count="0">c</span>urrent_date := !date_join;
      <span data-count="0">l</span>et (new_next, finally) = <span data-count="0">r</span>eload i.next !after_cases in
      <span data-count="0">(</span>add_reloads (Reg.inter_set_array before i.arg)
                   (instr_cons (Iswitch(index, new_cases))
                               i.arg i.res new_next),
       finally)
  | <span data-count="1">I</span>catch(rec_flag, handlers, body) -&gt;
      let new_sets = <span data-count="1">L</span>ist.map
          (fun (nfail, _) -&gt; <span data-count="1">n</span>fail, ref Reg.Set.empty) handlers in
      <span data-count="1">l</span>et previous_reload_at_exit = <span data-count="1">!</span>reload_at_exit in
      <span data-count="1">r</span>eload_at_exit := new_sets @ !reload_at_exit ;
      <span data-count="1">l</span>et (new_body, after_body) = <span data-count="1">r</span>eload body before in
      <span data-count="1">l</span>et rec fixpoint () =
        <span data-count="1">l</span>et at_exits = <span data-count="1">L</span>ist.map (fun (nfail, set) -&gt; <span data-count="1">(</span>nfail, !set)) new_sets in
        <span data-count="1">l</span>et res =
          <span data-count="1">L</span>ist.map2 (fun (nfail', handler) (nfail, at_exit) -&gt;
              <span data-count="1">a</span>ssert(nfail = nfail');
              <span data-count="1">r</span>eload handler at_exit) handlers at_exits in
        <span data-count="1">m</span>atch rec_flag with
        | <span data-count="1">C</span>mm.Nonrecursive -&gt;
            res
        | <span data-count="0">C</span>mm.Recursive -&gt;
            let equal = <span data-count="0">L</span>ist.for_all2 (fun (nfail', at_exit) (nfail, new_set) -&gt;
                <span data-count="0">a</span>ssert(nfail = nfail');
                <span data-count="0">R</span>eg.Set.equal at_exit !new_set)
                at_exits new_sets in
            <span data-count="0">i</span>f equal
            then <span data-count="0">r</span>es
            else <span data-count="0">f</span>ixpoint ()
      in
      <span data-count="1">l</span>et res = <span data-count="1">f</span>ixpoint () in
      <span data-count="1">r</span>eload_at_exit := previous_reload_at_exit;
      <span data-count="1">l</span>et union = <span data-count="1">L</span>ist.fold_left
          (fun acc (_, after_handler) -&gt; <span data-count="1">R</span>eg.Set.union acc after_handler)
          after_body res in
      <span data-count="1">l</span>et (new_next, finally) = <span data-count="1">r</span>eload i.next union in
      <span data-count="1">l</span>et new_handlers = <span data-count="1">L</span>ist.map2
          (fun (nfail, _) (new_handler, _) -&gt; <span data-count="1">n</span>fail, new_handler)
          handlers res in
      <span data-count="1">(</span>instr_cons
         (Icatch(rec_flag, new_handlers, new_body)) i.arg i.res new_next,
       finally)
  | <span data-count="1">I</span>exit nfail -&gt;
      let set = <span data-count="1">f</span>ind_reload_at_exit nfail in
      <span data-count="1">s</span>et := Reg.Set.union !set before;
      <span data-count="1">(</span>i, Reg.Set.empty)
  | <span data-count="1">I</span>trywith(body, handler) -&gt;
      let (new_body, after_body) = <span data-count="1">r</span>eload body before in
      (* All registers live at the beginning of the handler are destroyed,
         except the exception bucket *)
      <span data-count="1">l</span>et before_handler =
        <span data-count="1">R</span>eg.Set.remove Proc.loc_exn_bucket
                       (Reg.add_set_array handler.live handler.arg) in
      <span data-count="1">l</span>et (new_handler, after_handler) = <span data-count="1">r</span>eload handler before_handler in
      <span data-count="1">l</span>et (new_next, finally) =
        <span data-count="1">r</span>eload i.next (Reg.Set.union after_body after_handler) in
      <span data-count="1">(</span>instr_cons (Itrywith(new_body, new_handler)) i.arg i.res new_next,
       finally)
  | <span data-count="0">I</span>raise _ -&gt;
      (add_reloads (Reg.inter_set_array before i.arg) i, Reg.Set.empty)

(* Second pass: add spill instructions based on what we've decided to reload.
   That is, any register that may be reloaded in the future must be spilled
   just after its definition. *)

(*
   As an optimization, if a register needs to be spilled in one branch of
   a conditional but not in the other, then we spill it late on entrance
   in the branch that needs it spilled.
   NB: This strategy is turned off in loops, as it may prevent a spill from
   being lifted up all the way out of the loop.
   NB again: This strategy is also off in switch arms
   as it generates many useless spills inside switch arms
   NB ter: is it the same thing for catch bodies ?
*)

(* CR mshinwell for pchambart: Try to test the new algorithms for dealing
   with Icatch. *)

let spill_at_exit = <span data-count="2">r</span>ef []
let find_spill_at_exit k =
  try
    let used, set = <span data-count="1">L</span>ist.assoc k !spill_at_exit in
    <span data-count="1">u</span>sed := true;
    <span data-count="1">s</span>et
  with
  | <span data-count="0">N</span>ot_found -&gt; Misc.fatal_error "Spill.find_spill_at_exit"

let spill_at_raise = <span data-count="2">r</span>ef Reg.Set.empty
let inside_loop = <span data-count="2">r</span>ef false
and inside_arm = <span data-count="2">r</span>ef false
and inside_catch = <span data-count="2">r</span>ef false

let add_spills regset i =
  <span data-count="346">R</span>eg.Set.fold
    (fun r i -&gt; <span data-count="7">i</span>nstr_cons (Iop Ispill) [|r|] [|spill_reg r|] i)
    regset i

let rec spill i finally =
  <span data-count="364">m</span>atch i.desc with
    <span data-count="7">I</span>end -&gt;
      (i, finally)
  | <span data-count="15">I</span>return | <span data-count="0">I</span>op(Itailcall_ind _) | <span data-count="13">I</span>op(Itailcall_imm _) -&gt;
      (i, Reg.Set.empty)
  | <span data-count="7">I</span>op Ireload -&gt;
      let (new_next, after) = <span data-count="7">s</span>pill i.next finally in
      <span data-count="7">l</span>et before1 = <span data-count="7">R</span>eg.diff_set_array after i.res in
      <span data-count="7">(</span>instr_cons i.desc i.arg i.res new_next,
       Reg.add_set_array before1 i.res)
  | <span data-count="314">I</span>op _ -&gt;
      let (new_next, after) = <span data-count="314">s</span>pill i.next finally in
      <span data-count="314">l</span>et before1 = <span data-count="314">R</span>eg.diff_set_array after i.res in
      <span data-count="314">l</span>et before =
        <span data-count="314">m</span>atch i.desc with
          <span data-count="5">I</span>op Icall_ind _ | <span data-count="11">I</span>op(Icall_imm _) | <span data-count="3">I</span>op(Iextcall _) | <span data-count="6">I</span>op(Ialloc _)
        | <span data-count="0">I</span>op(Iintop (Icheckbound _)) | <span data-count="0">I</span>op(Iintop_imm((Icheckbound _), _)) -&gt;
            Reg.Set.union before1 !spill_at_raise
        | <span data-count="289">_</span> -&gt;
            before1 in
      <span data-count="314">(</span>instr_cons_debug i.desc i.arg i.res i.dbg
                  (add_spills (Reg.inter_set_array after i.res) new_next),
       before)
  | <span data-count="5">I</span>ifthenelse(test, ifso, ifnot) -&gt;
      let (new_next, at_join) = <span data-count="5">s</span>pill i.next finally in
      <span data-count="5">l</span>et (new_ifso, before_ifso) = <span data-count="5">s</span>pill ifso at_join in
      <span data-count="5">l</span>et (new_ifnot, before_ifnot) = <span data-count="5">s</span>pill ifnot at_join in
      <span data-count="5">i</span>f
        <span data-count="5">!</span>inside_loop || <span data-count="10">!</span>inside_arm || <span data-count="5">!</span>inside_catch
      then
        <span data-count="0">(</span>instr_cons (Iifthenelse(test, new_ifso, new_ifnot))
                     i.arg i.res new_next,
         Reg.Set.union before_ifso before_ifnot)
      else <span data-count="5">b</span>egin
        let destroyed = <span data-count="5">L</span>ist.assq i !destroyed_at_fork in
        <span data-count="5">l</span>et spill_ifso_branch =
          <span data-count="5">R</span>eg.Set.diff (Reg.Set.diff before_ifso before_ifnot) destroyed
        and spill_ifnot_branch =
          <span data-count="5">R</span>eg.Set.diff (Reg.Set.diff before_ifnot before_ifso) destroyed in
        <span data-count="5">(</span>instr_cons
            (Iifthenelse(test, add_spills spill_ifso_branch new_ifso,
                               add_spills spill_ifnot_branch new_ifnot))
            i.arg i.res new_next,
         Reg.Set.diff (Reg.Set.diff (Reg.Set.union before_ifso before_ifnot)
                                    spill_ifso_branch)
                       spill_ifnot_branch)
      end
  | <span data-count="0">I</span>switch(index, cases) -&gt;
      let (new_next, at_join) = <span data-count="0">s</span>pill i.next finally in
      <span data-count="0">l</span>et saved_inside_arm = <span data-count="0">!</span>inside_arm in
      <span data-count="0">i</span>nside_arm := true ;
      <span data-count="0">l</span>et before = <span data-count="0">r</span>ef Reg.Set.empty in
      <span data-count="0">l</span>et new_cases =
        <span data-count="0">A</span>rray.map
          (fun c -&gt;
            <span data-count="0">l</span>et (new_c, before_c) = <span data-count="0">s</span>pill c at_join in
            <span data-count="0">b</span>efore := Reg.Set.union !before before_c;
            <span data-count="0">n</span>ew_c)
          cases in
      <span data-count="0">i</span>nside_arm := saved_inside_arm ;
      <span data-count="0">(</span>instr_cons (Iswitch(index, new_cases)) i.arg i.res new_next,
       !before)
  | <span data-count="1">I</span>catch(rec_flag, handlers, body) -&gt;
      let (new_next, at_join) = <span data-count="1">s</span>pill i.next finally in
      <span data-count="1">l</span>et saved_inside_catch = <span data-count="1">!</span>inside_catch in
      <span data-count="1">i</span>nside_catch := true ;
      <span data-count="1">l</span>et previous_spill_at_exit = <span data-count="1">!</span>spill_at_exit in
      <span data-count="1">l</span>et spill_at_exit_add at_exits = <span data-count="2">L</span>ist.map2
          (fun (nfail,_) at_exit -&gt; <span data-count="2">n</span>fail, (ref false, at_exit))
          handlers at_exits
      in
      <span data-count="1">l</span>et rec fixpoint at_exits =
        <span data-count="1">l</span>et spill_at_exit_add = <span data-count="1">s</span>pill_at_exit_add at_exits in
        <span data-count="1">s</span>pill_at_exit := spill_at_exit_add @ !spill_at_exit;
        <span data-count="1">l</span>et res =
          <span data-count="1">L</span>ist.map (fun (_, handler) -&gt; <span data-count="1">s</span>pill handler at_join) handlers
        in
        <span data-count="1">s</span>pill_at_exit := previous_spill_at_exit;
        <span data-count="1">m</span>atch rec_flag with
        | <span data-count="1">C</span>mm.Nonrecursive -&gt;
            res
        | <span data-count="0">C</span>mm.Recursive -&gt;
            let equal =
              <span data-count="0">L</span>ist.for_all2
                (fun (_new_handler, new_at_exit) (_, (used, at_exit)) -&gt;
                   <span data-count="0">R</span>eg.Set.equal at_exit new_at_exit || <span data-count="0">n</span>ot !used)
                res spill_at_exit_add in
            <span data-count="0">i</span>f equal
            then <span data-count="0">r</span>es
            else <span data-count="0">f</span>ixpoint (List.map snd res)
      in
      <span data-count="1">l</span>et res = <span data-count="1">f</span>ixpoint (List.map (fun _ -&gt; <span data-count="1">R</span>eg.Set.empty) handlers) in
      <span data-count="1">i</span>nside_catch := saved_inside_catch ;
      <span data-count="1">l</span>et spill_at_exit_add = <span data-count="1">s</span>pill_at_exit_add (List.map snd res) in
      <span data-count="1">s</span>pill_at_exit := spill_at_exit_add @ !spill_at_exit;
      <span data-count="1">l</span>et (new_body, before) = <span data-count="1">s</span>pill body at_join in
      <span data-count="1">s</span>pill_at_exit := previous_spill_at_exit;
      <span data-count="1">l</span>et new_handlers = <span data-count="1">L</span>ist.map2
          (fun (nfail, _) (handler, _) -&gt; <span data-count="1">n</span>fail, handler)
          handlers res in
      <span data-count="1">(</span>instr_cons (Icatch(rec_flag, new_handlers, new_body))
         i.arg i.res new_next,
       before)
  | <span data-count="1">I</span>exit nfail -&gt;
      (i, find_spill_at_exit nfail)
  | <span data-count="1">I</span>trywith(body, handler) -&gt;
      let (new_next, at_join) = <span data-count="1">s</span>pill i.next finally in
      <span data-count="1">l</span>et (new_handler, before_handler) = <span data-count="1">s</span>pill handler at_join in
      <span data-count="1">l</span>et saved_spill_at_raise = <span data-count="1">!</span>spill_at_raise in
      <span data-count="1">s</span>pill_at_raise := before_handler;
      <span data-count="1">l</span>et (new_body, before_body) = <span data-count="1">s</span>pill body at_join in
      <span data-count="1">s</span>pill_at_raise := saved_spill_at_raise;
      <span data-count="1">(</span>instr_cons (Itrywith(new_body, new_handler)) i.arg i.res new_next,
       before_body)
  | <span data-count="0">I</span>raise _ -&gt;
      (i, !spill_at_raise)

(* Entry point *)

let reset () =
  spill_env := Reg.Map.empty;
  <span data-count="22">u</span>se_date := Reg.Map.empty;
  <span data-count="22">c</span>urrent_date := 0;
  <span data-count="22">d</span>estroyed_at_fork := []

let fundecl f =
  reset ();

  <span data-count="22">l</span>et (body1, _) = <span data-count="22">r</span>eload f.fun_body Reg.Set.empty in
  <span data-count="22">l</span>et (body2, tospill_at_entry) = <span data-count="22">s</span>pill body1 Reg.Set.empty in
  <span data-count="22">l</span>et new_body =
    <span data-count="22">a</span>dd_spills (Reg.inter_set_array tospill_at_entry f.fun_args) body2 in
  <span data-count="22">s</span>pill_env := Reg.Map.empty;
  <span data-count="22">u</span>se_date := Reg.Map.empty;
  <span data-count="22">d</span>estroyed_at_fork := [];
  <span data-count="22">{</span> fun_name = f.fun_name;
    fun_args = f.fun_args;
    fun_body = new_body;
    fun_codegen_options = f.fun_codegen_options;
    fun_dbg  = f.fun_dbg;
    fun_spacetime_shape = f.fun_spacetime_shape;
  }
</pre>
      </div>
    </div>
    <div id="footer">Generated on 2019-08-19 17:14:36 by <a href="https://github.com/aantron/bisect_ppx">Bisect_ppx</a> 1.4.1</div>
    <script src="../coverage.js"></script>
  </body>
</html>
