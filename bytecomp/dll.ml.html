<html>
  <head>
    <title>Coverage report</title>
    <link rel="stylesheet" href="../coverage.css" />
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">bytecomp/</span>dll.ml
        </a>
      </h1>
      <h2>12.90%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:26.95%"></span>
      <span class="unvisited" style="top:30.54%"></span>
      <span class="unvisited" style="top:32.93%"></span>
      <span class="unvisited" style="top:36.53%"></span>
      <span class="unvisited" style="top:37.13%"></span>
      <span class="unvisited" style="top:37.72%"></span>
      <span class="unvisited" style="top:38.32%"></span>
      <span class="unvisited" style="top:38.92%"></span>
      <span class="unvisited" style="top:39.52%"></span>
      <span class="unvisited" style="top:40.12%"></span>
      <span class="unvisited" style="top:40.72%"></span>
      <span class="unvisited" style="top:41.32%"></span>
      <span class="unvisited" style="top:42.51%"></span>
      <span class="unvisited" style="top:43.11%"></span>
      <span class="unvisited" style="top:43.71%"></span>
      <span class="unvisited" style="top:44.31%"></span>
      <span class="unvisited" style="top:47.31%"></span>
      <span class="unvisited" style="top:50.90%"></span>
      <span class="unvisited" style="top:51.50%"></span>
      <span class="unvisited" style="top:55.09%"></span>
      <span class="unvisited" style="top:55.69%"></span>
      <span class="unvisited" style="top:56.89%"></span>
      <span class="unvisited" style="top:57.49%"></span>
      <span class="unvisited" style="top:58.08%"></span>
      <span class="unvisited" style="top:58.68%"></span>
      <span class="unvisited" style="top:59.28%"></span>
      <span class="unvisited" style="top:60.48%"></span>
      <span class="unvisited" style="top:66.47%"></span>
      <span class="unvisited" style="top:67.07%"></span>
      <span class="unvisited" style="top:67.66%"></span>
      <span class="unvisited" style="top:71.26%"></span>
      <span class="unvisited" style="top:71.86%"></span>
      <span class="unvisited" style="top:72.46%"></span>
      <span class="unvisited" style="top:73.05%"></span>
      <span class="unvisited" style="top:74.25%"></span>
      <span class="unvisited" style="top:75.45%"></span>
      <span class="unvisited" style="top:76.65%"></span>
      <span class="unvisited" style="top:77.25%"></span>
      <span class="unvisited" style="top:78.44%"></span>
      <span class="unvisited" style="top:82.04%"></span>
      <span class="unvisited" style="top:83.23%"></span>
      <span class="unvisited" style="top:89.82%"></span>
      <span class="unvisited" style="top:95.21%"></span>
      <span class="unvisited" style="top:95.81%"></span>
      <span class="unvisited" style="top:96.41%"></span>
      <span class="unvisited" style="top:98.80%"></span>
      <span class="unvisited" style="top:99.40%"></span>
      <span class="unvisited" style="top:100.00%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span class="visited"> </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span class="visited"> </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span class="visited"> </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span > </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span class="unvisited"> </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span class="unvisited"> </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span class="visited"> </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span class="unvisited"> </span>
<a id="L56"></a><span > </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span class="unvisited"> </span>
<a id="L62"></a><span class="unvisited"> </span>
<a id="L63"></a><span class="unvisited"> </span>
<a id="L64"></a><span class="unvisited"> </span>
<a id="L65"></a><span class="unvisited"> </span>
<a id="L66"></a><span class="unvisited"> </span>
<a id="L67"></a><span class="unvisited"> </span>
<a id="L68"></a><span class="unvisited"> </span>
<a id="L69"></a><span class="unvisited"> </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span class="unvisited"> </span>
<a id="L72"></a><span class="unvisited"> </span>
<a id="L73"></a><span class="unvisited"> </span>
<a id="L74"></a><span class="unvisited"> </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span > </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="unvisited"> </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span > </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span class="unvisited"> </span>
<a id="L86"></a><span class="unvisited"> </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span > </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span class="unvisited"> </span>
<a id="L93"></a><span class="unvisited"> </span>
<a id="L94"></a><span > </span>
<a id="L95"></a><span class="unvisited"> </span>
<a id="L96"></a><span class="unvisited"> </span>
<a id="L97"></a><span class="unvisited"> </span>
<a id="L98"></a><span class="unvisited"> </span>
<a id="L99"></a><span class="unvisited"> </span>
<a id="L100"></a><span > </span>
<a id="L101"></a><span class="unvisited"> </span>
<a id="L102"></a><span > </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span > </span>
<a id="L108"></a><span class="visited"> </span>
<a id="L109"></a><span > </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span class="unvisited"> </span>
<a id="L112"></a><span class="unvisited"> </span>
<a id="L113"></a><span class="unvisited"> </span>
<a id="L114"></a><span > </span>
<a id="L115"></a><span > </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span > </span>
<a id="L118"></a><span > </span>
<a id="L119"></a><span class="unvisited"> </span>
<a id="L120"></a><span class="unvisited"> </span>
<a id="L121"></a><span class="unvisited"> </span>
<a id="L122"></a><span class="unvisited"> </span>
<a id="L123"></a><span > </span>
<a id="L124"></a><span class="unvisited"> </span>
<a id="L125"></a><span > </span>
<a id="L126"></a><span class="unvisited"> </span>
<a id="L127"></a><span > </span>
<a id="L128"></a><span class="unvisited"> </span>
<a id="L129"></a><span class="unvisited"> </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span class="unvisited"> </span>
<a id="L132"></a><span > </span>
<a id="L133"></a><span > </span>
<a id="L134"></a><span > </span>
<a id="L135"></a><span > </span>
<a id="L136"></a><span > </span>
<a id="L137"></a><span class="unvisited"> </span>
<a id="L138"></a><span > </span>
<a id="L139"></a><span class="unvisited"> </span>
<a id="L140"></a><span > </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span > </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span > </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span > </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span class="unvisited"> </span>
<a id="L151"></a><span > </span>
<a id="L152"></a><span > </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span > </span>
<a id="L155"></a><span > </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span > </span>
<a id="L158"></a><span > </span>
<a id="L159"></a><span class="unvisited"> </span>
<a id="L160"></a><span class="unvisited"> </span>
<a id="L161"></a><span class="unvisited"> </span>
<a id="L162"></a><span > </span>
<a id="L163"></a><span > </span>
<a id="L164"></a><span > </span>
<a id="L165"></a><span class="unvisited"> </span>
<a id="L166"></a><span class="unvisited"> </span>
<a id="L167"></a><span class="unvisited"> </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
</pre>
        <pre id="code">
(**************************************************************************)
(*                                                                        *)
(*                                 OCaml                                  *)
(*                                                                        *)
(*             Xavier Leroy, projet Cristal, INRIA Rocquencourt           *)
(*                                                                        *)
(*   Copyright 2001 Institut National de Recherche en Informatique et     *)
(*     en Automatique.                                                    *)
(*                                                                        *)
(*   All rights reserved.  This file is distributed under the terms of    *)
(*   the GNU Lesser General Public License version 2.1, with the          *)
(*   special exception on linking described in the file LICENSE.          *)
(*                                                                        *)
(**************************************************************************)

(* Handling of dynamically-linked libraries *)

type dll_handle
type dll_address
type dll_mode = For_checking | For_execution

external dll_open: dll_mode -&gt; string -&gt; dll_handle = "caml_dynlink_open_lib"
external dll_close: dll_handle -&gt; unit = "caml_dynlink_close_lib"
external dll_sym: dll_handle -&gt; string -&gt; dll_address
                = "caml_dynlink_lookup_symbol"
         (* returned dll_address may be Val_unit *)
external add_primitive: dll_address -&gt; int = "caml_dynlink_add_primitive"
external get_current_dlls: unit -&gt; dll_handle array
                                           = "caml_dynlink_get_current_libs"

(* Current search path for DLLs *)
let search_path = <span data-count="32">r</span>ef ([] : string list)

(* DLLs currently opened *)
let opened_dlls = <span data-count="32">r</span>ef ([] : dll_handle list)

(* File names for those DLLs *)
let names_of_opened_dlls = <span data-count="32">r</span>ef ([] : string list)

(* Add the given directories to the search path for DLLs. *)
let add_path dirs =
  search_path := dirs @ !search_path

let remove_path dirs =
  search_path := List.filter (fun d -&gt; <span data-count="0">n</span>ot (List.mem d dirs)) !search_path

(* Extract the name of a DLLs from its external name (xxx.so or -lxxx) *)

let extract_dll_name file =
  if Filename.check_suffix file Config.ext_dll then
    <span data-count="0">F</span>ilename.chop_suffix file Config.ext_dll
  else <span data-count="4">i</span>f <span data-count="4">S</span>tring.length file &gt;= 2 &amp;&amp; <span data-count="4">S</span>tring.sub file 0 2 = "-l" then
    <span data-count="4">"</span>dll" ^ String.sub file 2 (String.length file - 2)
  else
    <span data-count="0">f</span>ile (* will cause error later *)

(* Open a list of DLLs, adding them to opened_dlls.
   Raise [Failure msg] in case of error. *)

let open_dll mode name =
  <span data-count="0">l</span>et name = <span data-count="0">n</span>ame ^ Config.ext_dll in
  <span data-count="0">l</span>et fullname =
    <span data-count="0">t</span>ry
      let fullname = <span data-count="0">M</span>isc.find_in_path !search_path name in
      <span data-count="0">i</span>f Filename.is_implicit fullname then
        <span data-count="0">F</span>ilename.concat Filename.current_dir_name fullname
      else <span data-count="0">f</span>ullname
    with <span data-count="0">N</span>ot_found -&gt; name in
  <span data-count="0">i</span>f not (List.mem fullname !names_of_opened_dlls) then <span data-count="0">b</span>egin
    try
      let dll = <span data-count="0">d</span>ll_open mode fullname in
      <span data-count="0">n</span>ames_of_opened_dlls := fullname :: !names_of_opened_dlls;
      <span data-count="0">o</span>pened_dlls := dll :: !opened_dlls
    with <span data-count="0">F</span>ailure msg -&gt;
      failwith (fullname ^ ": " ^ msg)
  end

let open_dlls mode names =
  <span data-count="0">L</span>ist.iter (open_dll mode) names

(* Close all DLLs *)

let close_all_dlls () =
  List.iter dll_close !opened_dlls;
  <span data-count="0">o</span>pened_dlls := [];
  <span data-count="0">n</span>ames_of_opened_dlls := []

(* Find a primitive in the currently opened DLLs.
   Raise [Not_found] if not found. *)

let find_primitive prim_name =
  let rec find seen = <span data-count="0">f</span>unction
    <span data-count="0">[</span>] -&gt;
      raise Not_found
  | <span data-count="0">d</span>ll :: rem -&gt;
      let addr = <span data-count="0">d</span>ll_sym dll prim_name in
      <span data-count="0">i</span>f addr == Obj.magic () then <span data-count="0">f</span>ind (dll :: seen) rem else <span data-count="0">b</span>egin
        if seen &lt;&gt; [] then <span data-count="0">o</span>pened_dlls := dll :: List.rev_append seen rem;
        <span data-count="0">a</span>ddr
      end in
  <span data-count="0">f</span>ind [] !opened_dlls

(* If linking in core (dynlink or toplevel), synchronize the VM
   table of primitive with the linker's table of primitive
   by storing the given primitive function at the given position
   in the VM table of primitives.  *)

let linking_in_core = <span data-count="32">r</span>ef false

let synchronize_primitive num symb =
  <span data-count="0">i</span>f !linking_in_core then <span data-count="0">b</span>egin
    let actual_num = <span data-count="0">a</span>dd_primitive symb in
    <span data-count="0">a</span>ssert (actual_num = num)
  end

(* Read the [ld.conf] file and return the corresponding list of directories *)

let ld_conf_contents () =
  let path = <span data-count="0">r</span>ef [] in
  <span data-count="0">b</span>egin try
    let ic = <span data-count="0">o</span>pen_in (Filename.concat Config.standard_library "ld.conf") in
    <span data-count="0">b</span>egin try
      while true do
        <span data-count="0">p</span>ath := input_line ic :: !path
      done
    with <span data-count="0">E</span>nd_of_file -&gt; ()
    end;
    <span data-count="0">c</span>lose_in ic
  with <span data-count="0">S</span>ys_error _ -&gt; ()
  end;
  <span data-count="0">L</span>ist.rev !path

(* Split the CAML_LD_LIBRARY_PATH environment variable and return
   the corresponding list of directories.  *)
let ld_library_path_contents () =
  match Sys.getenv "CAML_LD_LIBRARY_PATH" with
  | <span data-count="0">e</span>xception Not_found -&gt;
      []
  | <span data-count="0">s</span> -&gt;
      Misc.split_path_contents s

let split_dll_path path =
  Misc.split_path_contents ~sep:'\000' path

(* Initialization for separate compilation *)

let init_compile nostdlib =
  search_path :=
    ld_library_path_contents() @
    (if nostdlib then <span data-count="0">[</span>] else <span data-count="0">l</span>d_conf_contents())

(* Initialization for linking in core (dynlink or toplevel) *)

let init_toplevel dllpath =
  search_path :=
    ld_library_path_contents() @
    split_dll_path dllpath @
    ld_conf_contents();
  <span data-count="0">o</span>pened_dlls := Array.to_list (get_current_dlls());
  <span data-count="0">n</span>ames_of_opened_dlls := [];
  <span data-count="0">l</span>inking_in_core := true

let reset () =
  search_path := [];
  <span data-count="0">o</span>pened_dlls :=[];
  <span data-count="0">n</span>ames_of_opened_dlls := [];
  <span data-count="0">l</span>inking_in_core := false
</pre>
      </div>
    </div>
    <div id="footer">Generated on 2019-08-19 17:14:36 by <a href="https://github.com/aantron/bisect_ppx">Bisect_ppx</a> 1.4.1</div>
    <script src="../coverage.js"></script>
  </body>
</html>
